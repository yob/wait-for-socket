#!/usr/bin/env ruby

require 'clamp'
require 'socket'

Clamp do

  option %w[--description -d], "<service name>", "Description of the service we're waiting for", default: 'service'
  option %w[--address -a], "<host or IP>", "The hostname or IP to monitor", required: true
  option %w[--port -p], "<port>", "The port number to monitor", required: true, &method(:Integer)
  option %w[--interval -i], "<seconds>", "The number of seconds to wait between polling attempts", default: 2, &method(:Float)

  def execute
    $stdout.sync = true
    puts "Waiting for #{description} to become available at #{address}:#{port_int}"
    loop do
      if socket_reachable?(address, port)
        puts
        puts "#{description} ready"
        break
      else
        $stderr.write "."
        sleep interval
      end
    end
  end

  private

  def socket_reachable?(hostname, port)
    Socket.tcp(hostname, port, connect_timeout: 2) {}
    true
  rescue StandardError => e
    false
  end

end
